<html>
<body>
	iframe from cometd.
	<script>
		document.domain = "test.com";

		if (typeof XMLHttpRequest == "undefined") {
			XMLHttpRequest = function () {
				try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); }
				catch (e1) {}
				try { return new ActiveXObject("Msxml2.XMLHTTP.3.0"); }
				catch (e2) {}
				try { return new ActiveXObject("Msxml2.XMLHTTP"); }
				catch (e3) {}
				try { return new ActiveXObject("Microsoft.XMLHTTP"); }
				catch (e4) {}
				throw new Error("This browser does not support XMLHttpRequest.");
			};
		}

		function ajax(url) {
			var xhr = new XMLHttpRequest;
			xhr.open("get",url, true);
			xhr.send(null);
		}

		function CometClient(host){
			this.host = host;
			this.pos = 0;

			this.auth = function(uid, sid) {
				
				this.uid = uid;
				this.sid = sid;

				url = "http://"+this.host+"/meta/authenticate?uid="+this.uid+"&sid="+this.sid;
				ajax(url);
			}

			this.connect = function(channel, onMsg) {
				
				var xhr = new XMLHttpRequest;
				xhr.open("get", "http://"+this.host+"/meta/connect?name="+channel+"&uid="+this.uid+"&sid="+this.sid, true);
				var comet = this;
				xhr.onreadystatechange = function() {
					var data = xhr.responseText;
					if(xhr.readyState === 3 || xhr.readyState == 4) {

						// check if we've read anything before.
						var curLen = data.length;
						do {
							var msg = cutMessage(data.substr(comet.pos));
							// console.log("got: ", msg, "length=", msg.length);
							// console.log("following: ", data.substr(comet.pos + msg.length, 10));

							try {
								var obj = JSON.parse(msg);
								comet.pos += msg.length;
								switch(obj[0]) {
									case 'msg':
										if(obj[1].channel == channel) {
											onMsg(obj[1]);
										} else { // wrong channel, raise error? (TODO)

										}
										break;

									case 'meta':
										// TODO: handle service messages
										break;
								}
							} catch(e) {
								console.log(e);
								console.log(msg);
								comet.connect(channel, onMsg);
							}
						} while(comet.pos + msg.length != data.length);

					}
					if(xhr.readyState == 4) { // reconnect
						comet.connect(channel, onMsg);
					}
				};
				xhr.send(null);
			}
		};

		function cutMessage(msg) {
			if(msg[0] != '[') {
				return null;
			}
			var pos, depth = 0;
			var in_string = false;
			var len = msg.length;

			for(pos = 0; pos < len; pos++) {
				switch(msg[pos]) {
					case '"':
						in_string = !in_string;
						if(in_string) {
							continue;
						}
						break;
					case '[':
						depth++;
						break;
					case ']':
						depth--;
						break;
				}
				if(depth == 0) {
					return msg.substr(0, pos+1);
				}
			}

			return null;

		}
	</script>
	
	
</body>
</html>
